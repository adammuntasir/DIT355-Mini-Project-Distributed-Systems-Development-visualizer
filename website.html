<!DOCTYPE html>

<html>

<head>
    <meta charset=utf-8 />
    <title>Load GeoJSON</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            height: 500px
        }
    </style>



    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous" />

    <!--jQuery library to populate the options using a function-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
    </script>

    <!-- MAPBOX -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css' rel='stylesheet' />

</head>

<body>
    <script src='paho-mqtt.js'>
    </script>

    <script>
    </script>
    <ul id='message-list'></ul>

    <div id="content" class="container-fluid fill-height">
        <div id='map'></div>
        <h1>Dentistimo</h1>

        <button onclick="bookChoice()">Book</button>

        <ul class="list-unstyled components">
            <!--<p class="para">year/month/week/wday/hour</p>-->
            <label for="yearSelect">Select Year:</label>
            <select name="yearDropDown" id="yearSelect">
        <option value="#">All</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
      </select>

            <label for="monthSelect">Select Month:</label>
            <select class="1-12" name="monthDropDown" id="monthSelect">
        <option value="#">All</option>
      </select>

            <label for="weekSelect">Select Day:</label>
            <select class="1-31" name="weekDropDown" id="weekSelect">
        <option value="#">All</option>
      </select>

            <label for="daySelect">Select Week Day:</label>
            <select name="dayDropDown" id="daySelect">
        <option value="#">All</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>

            <label for="hourSelect">Select Hour:</label>
            <select class="0-23" name="hourDropDown" id="hourSelect">
        <option value="#">All</option>
      </select>
            <label for="minuteSelect">Select Minutes:</label>

            <select name="minuteDropdown" id="minuteSelect">
        <option value="#">All</option>
                <option value=00>00</option>
        <option value=30>30</option>

      </select>
            <button type="button" class="btn btn-secondary" onclick="subscribeToTopic();">
        Subscribe
      </button>
        </ul>

        <script>
            var client = new Paho.Client('broker.hivemq.com', 8000, 'razraz');
            client.connect({
                onSuccess: function() {
                    console.log('connected');
                    client.subscribe('ramzimkoqaz1984qwe'); // get js object from data handler

                }
            });
            client.onMessageArrived = function(message) { // only takes messages from Paho, from data handler
                if (message.payloadString.length > 800) {

                    var topicArgument = retrieveTopic() // the date chosen by the user

                    var allCoordinates = new Array(); // create empty array to insert coordinates 

                    var wholeJSON = JSON.parse(message.payloadString) // get entire json from Data Handler
                        /*
                                            var countKey = Object.keys(wholeJSON.dentists).length; // how many elements in the array
                                            for (var m = 0; m < countKey; m++) {
                                                allCoordinates[m] = wholeJSON.dentists[m].coordinate // save all coordinates
                                            }
                                            var allCoordinatesString = JSON.stringify(allCoordinates)
                                            var withoutQuotes = allCoordinatesString.replace(/"/g, ''); // remove the quotes 
                                            var readyForMap = JSON.parse(withoutQuotes) // make the coordinates without quotes 
                        */

                    wholeJSON.dentists.forEach(function(e) {
                        var marker = new mapboxgl.Marker()
                            .setLngLat(e.coordinate) // variable 
                            .setPopup(new mapboxgl.Popup()
                                .setHTML(
                                    `<h5>${JSON.stringify(e.name)}</h5> 
                                    <h6>${JSON.stringify(e.address)}</h6> 
    <button   class="btn" >Book</button>`
                                ))

                        .addTo(map)
                        var topicReady = JSON.stringify(topicArgument)
                        marker.getElement().addEventListener('click', () => {
                            bookChoice(e.id, topicReady);
                        })

                        /*
                                 document.getElementsByClassName("btn")[0].addEventListener('mouseover', () => {bookChoice();})

                            marker.getElement().addEventListener('click', () => {
                                                    bookChoice();})
                        */
                    });
                } else {
                    console.log(message.payloadString)
                }

            }


            $(function() {
                var $select = $('.1-12')
                for (i = 1; i <= 12; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            $(function() {
                var $select = $('.1-31')
                for (i = 1; i <= 31; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            $(function() {
                var $select = $('.0-23')
                for (i = 0; i <= 23; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            var previousTopic = null

            function subscribeToTopic() {
                //GET SELECTED TOPIC
                var topic = this.retrieveTopic()
                    //  client.publish('ramzimkoqaz1984qwe2', retrieveTopic())

                client.publish('ramzimkoqaz1984qwe2', topic)
                    // we do not end the subscription until the topic is a valid type
                if (typeof previousTopic !== 'undefined') {
                    client.unsubscribe('ramzimkoqaz1984qwe2')
                }
                previousTopic = 'ramzimkoqaz1984qwe2'
            }

            // the topic will recieve should either contain the number, or # for all, or + and a number
            var retrieveTopic = function() {
                var newTopic = ''
                var fullTopic = ''
                var year = document.getElementById('yearSelect').value
                var month = document.getElementById('monthSelect').value
                var week = document.getElementById('weekSelect').value
                var day = document.getElementById('daySelect').value
                var hour = document.getElementById('hourSelect').value
                var minutes = document.getElementById('minuteSelect').value
                if (
                    year == '#' &&
                    month == '#' &&
                    week == '#' &&
                    day == '#' &&
                    hour == '#' &&
                    minutes == '#'

                ) {
                    fullTopic = '#'
                } else if (month == '#' && week == '#' && day == '#' && hour == '#' && minute == '#') {
                    fullTopic = year + '/' + '#'
                } else if (week == '#' && day == '#' && hour == '#' && minute == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    fullTopic = newTopic.concat(year + '/' + month + '/' + '#')
                } else if (day == '#' && hour == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + '#'
                    )
                } else if (hour == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    if (week == '#') {
                        week = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + day + '/' + '#'
                    )
                } else {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    if (week == '#') {
                        week = '+'
                    }
                    if (day == '#') {
                        day = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + day + '/' + hour + '/' + minutes
                    )
                }

                return fullTopic
            }

            function clientData(dentistId, timeChosen) {
                var emptyObj = {
                    clientId: "",
                    requestId: "",
                    bookingTime: "",
                    issuance: "",
                    dentistID: "",
                    clientTime: "",
                    clientCoordinates: ""
                };
                //console.log(emptyObj);
                var idFilled = this.idGenerate(emptyObj, dentistId, timeChosen);
                var timeFilled = this.timeGenerate(idFilled);
                var issuanceFilled = this.issuanceGenerate(timeFilled)
                var dentistCoordinates = this.addClientCoordinates(issuanceFilled);
                var completedStringified = JSON.stringify(dentistCoordinates);
                return completedStringified;
            }

            function idGenerate(emptyVar, dentistId, timeChosen) {

                emptyVar.clientId = parseInt(Math.random() * (500000 - 1) + 1); // create client id inside client object
                emptyVar.requestId = dentistId + parseInt(Math.random() * ((dentistId * 153) / 2 - 1) + 1);; // create requestId variable inside client object
                emptyVar.dentistID = dentistId; // create requestId variable inside client object

                emptyVar.clientTime = timeChosen;
                return emptyVar;
            }

            function issuanceGenerate(emptyVar) {
                var currentTime = Date.now();
                emptyVar.issuance = currentTime; // create issuance variable for client object
                return emptyVar;
            }

            function timeGenerate(emptyVar) {

                Date.now()
                var newTime = new Date()

                var currentHour = newTime.getHours();

                var currentMinute = newTime.getMinutes();
                var currentDayOfMonth = newTime.getDay();
                var currentMonth = newTime.getMonth(); // Be careful! January is 0, not 1
                var currentYear = newTime.getFullYear();

                var dateString = currentHour + ":" + currentMinute + " " + currentYear + "-" + (currentMonth + 1) + "-" + currentDayOfMonth;
                emptyVar.bookingTime = dateString; // we create a variable inside the client object

                return emptyVar;
            }

            var previousTopic2 = null

            function addClientCoordinates(emptyVar) {
                clientCoordinates = "[11.969388,57.707619]"; // this should be dynamically filled 
                emptyVar.clientCoordinates = clientCoordinates;
                return emptyVar
            }
            var bookChoice = function(dentistId, time) {
                //console.log(time)
                var userData = this.clientData(dentistId, time)
                console.log(userData)
                client.publish('ramzimkoqaz1984qwe2', userData)

                var timeout = setTimeout("location.reload(true);", 4000);

                function resetTimeout() {
                    clearTimeout(timeout);
                    timeout = setTimeout("location.reload(true);", 4000);
                }
                // we do not end the subscription until the topic is a valid type
                if (typeof previousTopic2 !== 'undefined') {
                    client.unsubscribe('ramzimkoqaz1984qwe2')
                }

            }


            // access token
            mapboxgl.accessToken = 'pk.eyJ1IjoibWtvcWF6IiwiYSI6ImNrdnRlanNnZjJ1amcycWtsbmFjN2xscXUifQ.MDV-Vx3y_vY_DM-YFF9eGw'

            // javascript to instantiate the map
            const map = new mapboxgl.Map({
                container: 'map', // appear in the container with the id called map
                style: 'mapbox://styles/mapbox/streets-v9', // style URL
                center: [11.942625, 57.685259], //starting position [lng, lat]
                zoom: 10, // starting zoom
            })
        </script>
</body>

</html>