<!DOCTYPE html>

<html>

<head>
    <meta charset=utf-8 />
    <title>Load GeoJSON</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <style>
        #snackbar {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }
        
        #snackbar.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }
            to {
                bottom: 30px;
                opacity: 1;
            }
        }
        
        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }
            to {
                bottom: 30px;
                opacity: 1;
            }
        }
        
        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }
            to {
                bottom: 0;
                opacity: 0;
            }
        }
        
        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }
            to {
                bottom: 0;
                opacity: 0;
            }
        }
        
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            height: 500px
        }
        /* The Modal (background) */
    </style>

    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous" />

    <!--jQuery library to populate the options using a function-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
    </script>

    <!-- MAPBOX -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css' rel='stylesheet' />

</head>

<body>
    <script src='paho-mqtt.js'>
    </script>

    <script>
    </script>
    <ul id='message-list'></ul>

    <div id="content" class="container-fluid fill-height">
        <div id='map'></div>
        <h1>Dentistimo</h1>

        <!--    <button onclick="bookChoice()">Book</button> -->

        <ul class="list-unstyled components">
            <!--<p class="para">year/month/week/wday/hour</p>-->
            <label for="yearSelect">Select Year:</label>
            <select name="yearDropDown" id="yearSelect">
        <option value="#">All</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
      </select>

            <label for="monthSelect">Select Month:</label>
            <select class="1-12" name="monthDropDown" id="monthSelect">
        <option value="#">All</option>
      </select>

            <label for="weekSelect">Select Day:</label>
            <select class="1-31" name="weekDropDown" id="weekSelect">
        <option value="#">All</option>
      </select>

            <label for="daySelect">Select Week Day:</label>
            <select name="dayDropDown" id="daySelect">
        <option value="#">All</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
      </select>

            <label for="hourSelect">Select Hour:</label>
            <select class="0-23" name="hourDropDown" id="hourSelect">
        <option value="#">All</option>
      </select>
            <label for="minuteSelect">Select Minutes:</label>

            <select name="minuteDropdown" id="minuteSelect">
        <option value="#">All</option>
                <option value=00>00</option>
        <option value=30>30</option>

      </select>
            <button type="button" class="btn btn-secondary" onclick="subscribeToTopic();">
        Subscribe
      </button>
        </ul>
        <script>
            var client = new Paho.Client('broker.hivemq.com', 8000, 'razraz');
            client.connect({
                onSuccess: function() {
                    console.log('connected');
                    client.subscribe('ramzimkoqaz1984qwe1'); // get js object from data handler

                }
            });
            client.onMessageArrived = function(message) { // only takes messages from Paho, from data handler
                if (message.payloadString.length > 800) {
                    var topicArgument = retrieveTopic() // the date chosen by the user

                    var wholeJSON = JSON.parse(message.payloadString) // get entire json from Data Handler
                        //console.log(wholeJSON[1].takenData.length)

                    allCoordinates = (wholeJSON[1].takenData)
                    map.doubleClickZoom.disable();

                    wholeJSON[0].dentists.forEach(function(e) {
                        var marker = new mapboxgl.Marker()
                            .setLngLat(e.coordinate) // variable 
                            .setPopup(new mapboxgl.Popup()
                                .setHTML(
                                    `<h6>${JSON.stringify(e.name)}</h6> 
                                    <br>
                                    <h7> Owner Name: ${JSON.stringify(e.owner)}</h7>                                     
                                    <br>
                                    <h7> Number of Dentists:${JSON.stringify(e.dentists)}</h7>                                     
                                    <br>
                                    <h7> Address:${JSON.stringify(e.address)}</h7> 
                                    <br>
                                    <h7> Lunch Hours: 12:00 - 13:00 </h7> 
                                    <br>
                                    <h7> Fika Hours: 15:00 - 15:30 </h7>
                                    <br>
                                    `
                                )).addTo(map)


                        allCoordinates.forEach(function(c) {

                            var marker2 = new mapboxgl.Marker({
                                    "color": "#b40219"
                                })
                                .setLngLat(c)
                                .setPopup(new mapboxgl.Popup())
                                .addTo(map)
                        })

                        var topicReady = JSON.stringify(topicArgument)

                        /*
                        var element = document.getElementsByClassName("view-full")
                        element.addEventListener('click',
                                bookChoice(e.id, topicReady, e.coordinate), false
                            )
                            */
                        marker.getElement().addEventListener('dblclick', () => {
                            bookChoice(e.id, topicReady, e.coordinate);
                        })



                    });


                } else if (message.payloadString[0] === "{" && message.payloadString.length < 50) {
                    //console.log(message.payloadString)

                    var objectify = JSON.parse(message.payloadString)
                    var messageTaken3 = objectify
                    if (objectify.hasOwnProperty('time')) {
                        console.log("Booking Response")
                        console.log(messageTaken3)
                            //show toast for a couple of seconds 

                        forToast = JSON.stringify(messageTaken3) // make the info string
                        document.getElementById("myText").innerHTML = forToast; // insert it into div (it includes snacbar id)

                        var x = document.getElementById("snackbar"); // get the snackbar div
                        x.className = "show"; // add show class (in styles you will see what it is)
                        setTimeout(function() {
                            x.className = x.className.replace("show", ""); // make it dont show after 6 seconds
                        }, 3000);
                        turnOffButtons = 1

                    } else if (objectify.hasOwnProperty('c')) {
                        setTimeout(function() {

                            console.log("Circuit Breaker Opened") // show in the consoel

                            // make the toast say Circuit Breaker Open
                            document.getElementById("myText").innerHTML = "Circuit Breaker Open";
                            var x = document.getElementById("snackbar"); // get the snackbar div
                            x.className = "show"; // add show class (in styles you will see what it is)
                            x.className = x.className.replace("show", ""); // make it dont show after 6 seconds

                            // make the entire website to stop working so that the subscriber does not receive and buttons dont work

                            /*
                            var blurDiv = document.createElement("div");
                            blurDiv.id = "blurDiv";
                            blurDiv.style.cssText = "position:absolute; top:0; right:0; width:" + screen.width + "px; height:" + screen.height + "px; background-color: #000000; opacity:0.5; filter:alpha(opacity=50)";
                            document.getElementsByTagName("body")[0].appendChild(blurDiv);
                            */
                        }, 3000);
                    }
                    /*
                    var blurDiv = document.getElementById("blurDiv");
                    blurDiv.parentNode.removeChild(blurDiv);
                    */
                }
            }



            $(function() {
                var $select = $('.1-12')
                for (i = 1; i <= 12; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            $(function() {
                var $select = $('.1-31')
                for (i = 1; i <= 31; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            $(function() {
                var $select = $('.0-23')
                for (i = 0; i <= 23; i++) {
                    $select.append($('<option></option>').val(i).html(i))
                }
            })

            var previousTopic = null

            function subscribeToTopic() {
                //GET SELECTED TOPIC
                var topic = this.retrieveTopic()
                    //  client.publish('ramzimkoqaz1984qwe2', retrieveTopic())
                client.publish('ramzimkoqaz1984qwe22', topic)
                    // we do not end the subscription until the topic is a valid type
                if (typeof previousTopic !== 'undefined') {
                    client.unsubscribe('ramzimkoqaz1984qwe22')
                }
                previousTopic = 'ramzimkoqaz1984qwe22'
            }


            function doNothing() {}

            // the topic will recieve should either contain the number, or # for all, or + and a number
            var retrieveTopic = function() {
                var newTopic = ''
                var fullTopic = ''
                var year = document.getElementById('yearSelect').value
                var month = document.getElementById('monthSelect').value
                var week = document.getElementById('weekSelect').value
                var day = document.getElementById('daySelect').value
                var hour = document.getElementById('hourSelect').value
                var minutes = document.getElementById('minuteSelect').value
                if (
                    year == '#' &&
                    month == '#' &&
                    week == '#' &&
                    day == '#' &&
                    hour == '#' &&
                    minutes == '#'

                ) {
                    fullTopic = '#'
                } else if (month == '#' && week == '#' && day == '#' && hour == '#' && minute == '#') {
                    fullTopic = year + '/' + '#'
                } else if (week == '#' && day == '#' && hour == '#' && minute == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    fullTopic = newTopic.concat(year + '/' + month + '/' + '#')
                } else if (day == '#' && hour == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + '#'
                    )
                } else if (hour == '#') {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    if (week == '#') {
                        week = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + day + '/' + '#'
                    )
                } else {
                    if (year == '#') {
                        year = '+'
                    }
                    if (month == '#') {
                        month = '+'
                    }
                    if (week == '#') {
                        week = '+'
                    }
                    if (day == '#') {
                        day = '+'
                    }
                    fullTopic = newTopic.concat(
                        year + '/' + month + '/' + week + '/' + day + '/' + hour + '/' + minutes
                    )
                }

                return fullTopic
            }

            function clientData(dentistId, timeChosen, coordinateChosen) {
                var emptyObj = {
                    userId: "",
                    requestId: "",
                    dentistID: "",
                    issuance: "",
                    date: "",
                    clientCoordinates: ""
                };
                //console.log(emptyObj);
                var idFilled = this.idGenerate(emptyObj, dentistId, timeChosen, coordinateChosen);
                var issuanceFilled = this.issuanceGenerate(idFilled)
                var completedStringified = JSON.stringify(issuanceFilled);
                return completedStringified;
            }

            function idGenerate(emptyVar, dentistId, timeChosen, coordinateChosen) {

                emptyVar.userId = parseInt(Math.random() * (500000 - 1) + 1); // create client id inside client object
                emptyVar.requestId = dentistId + parseInt(Math.random() * ((dentistId * 153) / 2 - 1) + 1);; // create requestId variable inside client object
                emptyVar.dentistID = dentistId; // create requestId variable inside client object

                var modifyDateFormat = JSON.parse(timeChosen)
                var splitUpString = timeChosen.split('/');
                var year = splitUpString[0]
                var month = splitUpString[1]
                var day = splitUpString[2]
                var hour = splitUpString[4]
                var minute = splitUpString[5]
                var yearWithoutQuotes = year.replace(/"/g, ''); // remove the quotes 
                var minuteWithoutQuotes = minute.replace(/"/g, ''); // remove the quotes 


                emptyVar.date = yearWithoutQuotes + "-" + month + "-" + day + " " + hour + ":" + minuteWithoutQuotes;

                emptyVar.clientCoordinates = coordinateChosen
                return emptyVar;

            }

            function issuanceGenerate(emptyVar) {
                var currentTime = Date.now();
                emptyVar.issuance = currentTime; // create issuance variable for client object
                return emptyVar;
            }

            var previousTopic2 = null


            var bookChoice = function(dentistId, time, coordinate) {
                //console.log(time)
                var userData = this.clientData(dentistId, time, coordinate)
                console.log("Booking Request")
                console.log(userData)
                client.publish('ramzimkoqaz1984qwe22', userData)

                // var timeout = setTimeout("location.reload(true);", 4000);
                /*
                                function resetTimeout() {
                                    clearTimeout(timeout);
                                    timeout = setTimeout("location.reload(true);", 4000);
                                }
                                */
                // we do not end the subscription until the topic is a valid type
                if (typeof previousTopic2 !== 'undefined') {
                    client.unsubscribe('ramzimkoqaz1984qwe22')
                }

            }


            // access token
            mapboxgl.accessToken = 'pk.eyJ1IjoibWtvcWF6IiwiYSI6ImNrdnRlanNnZjJ1amcycWtsbmFjN2xscXUifQ.MDV-Vx3y_vY_DM-YFF9eGw'

            // javascript to instantiate the map
            const map = new mapboxgl.Map({
                container: 'map', // appear in the container with the id called map
                style: 'mapbox://styles/mapbox/streets-v9', // style URL
                center: [11.942625, 57.685259], //starting position [lng, lat]
                zoom: 10, // starting zoom
            })
        </script>

        <div id="snackbar"><span id="myText"></span></div>


</body>

</html>